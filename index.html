<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ProTraderHack</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#0b1220; color:white; }
    .center { text-align:center; margin-top:100px; }
    #home-screen,#search-screen,#account-screen,#admin-screen { display:none; padding:20px; }
    nav { position:fixed; bottom:0; width:100%; display:flex; background:#111827; }
    nav button { flex:1; padding:14px; border:0; background:none; color:white; font-size:16px; }
    .blur { filter: blur(8px); }
  </style>
</head>
<body>
  <!-- Auth -->
  <div id="auth-screen" class="center">
    <h2>üîí Login to ProTraderHack</h2>
    <input id="email" type="email" placeholder="Email"><br><br>
    <input id="password" type="password" placeholder="Password"><br><br>
    <button onclick="signup()">Sign Up</button>
    <button onclick="login()">Login</button>
  </div>

  <!-- Key Gate -->
  <div id="key-gate" class="center" style="display:none;">
    <h2>üîë Enter your key</h2>
    <input id="userKey" placeholder="Enter key"><br><br>
    <button onclick="validateKey()">Unlock</button>
  </div>

  <!-- Home -->
  <div id="home-screen">
    <h2>üè† Home</h2>
    <div id="signals"></div>
  </div>

  <!-- Search -->
  <div id="search-screen">
    <h2>üîé Search</h2>
    <input id="searchInput" placeholder="Search pairs">
    <div id="searchResults"></div>
  </div>

  <!-- Account -->
<div id="account-screen">
  <h2>üë§ Account</h2>
  <select id="brokerSelect">
    <option value="zerodha">Zerodha</option>
    <option value="angelone">AngelOne</option>
    <option value="binance">Binance</option>
    <option value="exness">Exness</option>
  </select><br><br>
  <input id="amount" placeholder="Enter amount"><br><br>
  <button onclick="deposit()">Deposit</button>
  <button onclick="withdraw()">Withdraw</button>
  <div id="txnHistory"></div>
</div>

<script>
async function deposit(){
  const broker=document.getElementById("brokerSelect").value;
  const amount=document.getElementById("amount").value;
  const res=await fetch(BACKEND+"/deposit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user:auth.currentUser.email,broker,amount})});
  const d=await res.json();
  if(d.redirect_url){ window.open(d.redirect_url,"_blank"); }
  document.getElementById("txnHistory").innerHTML+="<div>Deposit ‚Üí "+broker+" ‚Üí "+d.status+"</div>";
}

async function withdraw(){
  const broker=document.getElementById("brokerSelect").value;
  const amount=document.getElementById("amount").value;
  const res=await fetch(BACKEND+"/withdraw",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user:auth.currentUser.email,broker,amount})});
  const d=await res.json();
  if(d.redirect_url){ window.open(d.redirect_url,"_blank"); }
  document.getElementById("txnHistory").innerHTML+="<div>Withdraw ‚Üí "+broker+" ‚Üí "+d.status+"</div>";
}
  </script>

  <!-- Admin -->
  <div id="admin-screen">
    <h2>‚öôÔ∏è Admin</h2>
    <p>Restricted</p>
  </div>

  <nav>
    <button onclick="show('home-screen')">Home</button>
    <button onclick="show('search-screen')">Search</button>
    <button onclick="show('account-screen')">Account</button>
    <button onclick="show('admin-screen')">Admin</button>
  </nav>

  <script>
    const BACKEND="https://protrader-backend-sbus.onrender.com";
    const firebaseConfig = {
      apiKey: "AIzaSyC-Vt0JpfAMj9uTdZHXXyot2FvB4lQ_vvE",
      authDomain: "protraderhack-d67f0.firebaseapp.com",
      projectId: "protraderhack-d67f0",
      storageBucket: "protraderhack-d67f0.firebasestorage.app",
      messagingSenderId: "1062485216321",
      appId: "1:1062485216321:web:f34bb52a8acc0a75b24ac0"
    };
    firebase.initializeApp(firebaseConfig);
    const auth=firebase.auth(); const db=firebase.firestore();

    function signup(){ auth.createUserWithEmailAndPassword(email.value,password.value).catch(e=>alert(e.message)); }
    function login(){ auth.signInWithEmailAndPassword(email.value,password.value).catch(e=>alert(e.message)); }
    auth.onAuthStateChanged(u=>{ if(u){ document.getElementById("auth-screen").style.display="none"; document.getElementById("key-gate").style.display="block"; }});

    async function validateKey(){
      const res=await fetch(BACKEND+"/validate_key",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:document.getElementById("userKey").value})});
      const d=await res.json();
      if(d.valid){ document.getElementById("key-gate").style.display="none"; show("home-screen"); listenSignals(); listenNotifications(); }
      else{ alert("Key invalid: "+d.reason); }
    }

    function show(id){ ["home-screen","search-screen","account-screen","admin-screen"].forEach(x=>document.getElementById(x).style.display="none"); document.getElementById(id).style.display="block"; }

    function deposit(){ logTxn("deposit"); }
    function withdraw(){ logTxn("withdraw"); }
    async function logTxn(type){
      const entry={user:auth.currentUser.email, broker:"demo", type};
      await fetch(BACKEND+"/transaction",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(entry)});
      document.getElementById("txnHistory").innerHTML+="<div>"+type+" logged</div>";
    }

    function listenSignals(){
      db.collection("signals").orderBy("timestamp","desc").limit(10).onSnapshot(snap=>{
        let html=""; snap.forEach(d=>{const s=d.data(); html+=`<div>${s.symbol} ${s.signal} @ ${s.last_price||"-"}</div>`;}); document.getElementById("signals").innerHTML=html;
      });
    }

    function listenNotifications(){
      db.collection("notifications").orderBy("timestamp","desc").limit(5).onSnapshot(snap=>{
        snap.forEach(d=>{const n=d.data(); alert("üîî "+n.symbol+" ‚Üí "+n.signal+" ("+n.message+")");});
      });
    }
  </script>
</body>
</html>
