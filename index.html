<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ProTraderHack</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#0b1220; color:#fff; }
    .hidden { display:none; }
    .nav { position:fixed; bottom:0; width:100%; display:flex; justify-content:space-around; background:#111; padding:10px; }
    .nav button { background:none; border:none; color:#fff; font-size:18px; }
    .screen { padding:20px; }
    input,button,select { margin:5px; padding:10px; border-radius:5px; border:none; }
    input,select { width:90%; }
    button { background:#3b82f6; color:white; cursor:pointer; }
  </style>
</head>
<body>
  <!-- 🔒 Auth -->
  <div id="auth-screen" class="screen">
    <h2>🔑 Login / Signup</h2>
    <input id="email" type="email" placeholder="Email"><br>
    <input id="password" type="password" placeholder="Password"><br>
    <input id="username" placeholder="Username (a-z0-9, max 12)"><br>
    <button onclick="signup()">Sign Up</button>
    <button onclick="login()">Login</button>
  </div>

  <!-- 🔓 Lock Screen -->
  <div id="lock-screen" class="screen hidden">
    <h2>🔒 Enter Access Key</h2>
    <input id="accessKey" placeholder="Enter Key"><br>
    <button onclick="unlock()">Unlock</button>
  </div>

  <!-- 🏠 Home -->
  <div id="home-screen" class="screen hidden">
    <h2>🏠 Home</h2>
    <p id="balance">Balance: --</p>
    <button onclick="trade('BUY')">Buy</button>
    <button onclick="trade('SELL')">Sell</button>
  </div>

  <!-- 🔍 Search -->
  <div id="search-screen" class="screen hidden">
    <h2>🔍 Search</h2>
    <input id="searchPair" placeholder="Search Pair"><br>
    <button onclick="addToWatchlist()">Add to Watchlist</button>
    <div id="watchlist"></div>
  </div>

  <!-- 👤 Account -->
  <div id="account-screen" class="screen hidden">
    <h2>👤 Account</h2>

    <!-- Zerodha -->
    <h3>Zerodha Login</h3>
    <input id="zerodhaApiKey" placeholder="API Key"><br>
    <input id="zerodhaClientId" placeholder="Client ID"><br>
    <input id="zerodhaPassword" type="password" placeholder="Password"><br>
    <input id="zerodhaTotp" placeholder="TOTP Secret"><br>
    <button onclick="zerodhaLogin()">Login Zerodha</button>

    <!-- AngelOne -->
    <h3>AngelOne Login</h3>
    <input id="angelApiKey" placeholder="API Key"><br>
    <input id="angelClientId" placeholder="Client ID"><br>
    <input id="angelPassword" type="password" placeholder="Password"><br>
    <input id="angelTotp" placeholder="TOTP Secret"><br>
    <button onclick="angelLogin()">Login AngelOne</button>

    <!-- Deposit / Withdraw -->
    <h3>💳 Deposit / Withdraw</h3>
    <select id="brokerSelect">
      <option value="">Select Broker</option>
      <option value="zerodha">Zerodha</option>
      <option value="angelone">AngelOne</option>
      <option value="binance">Binance</option>
      <option value="exness">Exness</option>
    </select><br>
    <button onclick="deposit()">Deposit</button>
    <button onclick="withdraw()">Withdraw</button>
    <div id="txnHistory"></div>
  </div>

  <!-- Navigation -->
  <div class="nav hidden" id="bottom-nav">
    <button onclick="showScreen('home-screen')">🏠</button>
    <button onclick="showScreen('search-screen')">🔍</button>
    <button onclick="showScreen('account-screen')">👤</button>
  </div>

  <script>
    const BACKEND = "https://protrader-backend-sbus.onrender.com";
    let txnHistory = [];

    function showScreen(id){
      document.querySelectorAll(".screen").forEach(s=>s.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
    }

    // --- Auth ---
    async function signup(){
      const username = document.getElementById("username").value;
      if(!/^[a-z0-9]{1,12}$/.test(username)){
        alert("❌ Invalid username. Use a-z, 0-9, max 12 chars.");
        return;
      }
      alert("✅ Signed up (Firebase auth code pending)");
      showScreen("lock-screen");
    }

    async function login(){
      alert("✅ Logged in (Firebase auth code pending)");
      showScreen("lock-screen");
    }

    async function unlock(){
      const key = document.getElementById("accessKey").value;
      const res = await fetch(BACKEND+"/validate_key", {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({key})
      });
      const data = await res.json();
      if(data.valid){
        alert("✅ Key accepted!");
        showScreen("home-screen");
        document.getElementById("bottom-nav").classList.remove("hidden");
      } else {
        alert("❌ Invalid/Expired key");
      }
    }

    // --- Broker logins ---
    async function zerodhaLogin(){
      const apiKey=document.getElementById("zerodhaApiKey").value;
      const clientId=document.getElementById("zerodhaClientId").value;
      const password=document.getElementById("zerodhaPassword").value;
      const totpSecret=document.getElementById("zerodhaTotp").value;

      const res=await fetch(BACKEND+"/zerodha/login",{
        method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({apiKey,clientId,password,totpSecret})
      });
      const data=await res.json();
      if(data.error){ alert("❌ "+data.error); }
      else { window.open(data.login_url,"_blank"); }
    }

    async function angelLogin(){
      const apiKey=document.getElementById("angelApiKey").value;
      const clientId=document.getElementById("angelClientId").value;
      const password=document.getElementById("angelPassword").value;
      const totpSecret=document.getElementById("angelTotp").value;

      const res=await fetch(BACKEND+"/angelone/login",{
        method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({apiKey,clientId,password,totpSecret})
      });
      const data=await res.json();
      if(data.error){ alert("❌ "+data.error); }
      else { alert("✅ AngelOne Login Success!"); console.log(data); }
    }

    // --- Deposit / Withdraw ---
    function deposit(){
      const broker=document.getElementById("brokerSelect").value;
      if(!broker){ alert("Select broker"); return; }
      if(broker==="zerodha"){ window.open("https://console.zerodha.com/funds/add", "_blank"); }
      else if(broker==="angelone"){ window.open("https://trade.angelone.in", "_blank"); }
      else { alert("Deposit API integration coming soon for "+broker); }
      logTxn("Deposit",broker);
    }

    function withdraw(){
      const broker=document.getElementById("brokerSelect").value;
      if(!broker){ alert("Select broker"); return; }
      if(broker==="zerodha"){ window.open("https://console.zerodha.com/funds/withdraw", "_blank"); }
      else if(broker==="angelone"){ window.open("https://trade.angelone.in", "_blank"); }
      else { alert("Withdraw API integration coming soon for "+broker); }
      logTxn("Withdraw",broker);
    }

    // --- Transaction History ---
    function logTxn(type,broker){
      const entry={type,broker,status:"processing",time:new Date().toLocaleString()};
      txnHistory.unshift(entry);
      renderHistory();
      setTimeout(()=>{ entry.status="completed"; renderHistory(); },3000); // fake complete
    }

    function renderHistory(){
      const el=document.getElementById("txnHistory");
      el.innerHTML="<h4>Transaction History</h4>";
      txnHistory.forEach(t=>{
        el.innerHTML+=`<div>${t.time} - ${t.type} (${t.broker}) - <strong>${t.status}</strong></div>`;
      });
    }

    // --- Demo trades ---
    function trade(type){ alert("Placed "+type+" order (demo)"); }
    function addToWatchlist(){ alert("Added to watchlist (demo)"); }
  </script>
</body>
    </html>
