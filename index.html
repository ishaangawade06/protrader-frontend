<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ProTraderHack</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { background:#0b1220; color:#e6eef8; font-family:Inter,Arial; }
    .screen { display:none; padding:16px; }
    .active { display:block; }
    .nav { position:fixed; bottom:0; left:0; right:0; display:flex; justify-content:space-around; background:#111827; padding:10px; }
    .nav button { flex:1; padding:8px; font-size:14px; }
    .locked { filter: blur(6px); pointer-events: none; }
    .center-lock { display:flex; justify-content:center; align-items:center; height:70vh; }
    .lock-btn { font-size:40px; cursor:pointer; }
    .balance-box { background:#1f2937; padding:10px; border-radius:8px; margin-bottom:10px; }
  </style>
</head>
<body class="p-4">

  <!-- Auth -->
  <div id="authScreen" class="screen active">
    <h2 class="text-xl font-bold mb-4">Welcome to ProTraderHack</h2>
    <input id="username" placeholder="Username (small letters/numbers)" class="w-full p-2 mb-2 rounded bg-gray-900" />
    <input id="email" placeholder="Email" class="w-full p-2 mb-2 rounded bg-gray-900" />
    <input id="password" type="password" placeholder="Password" class="w-full p-2 mb-2 rounded bg-gray-900" />
    <button id="signupBtn" class="w-full py-2 mb-2 rounded bg-green-600">Sign Up</button>
    <button id="loginBtn" class="w-full py-2 mb-2 rounded bg-blue-600">Log In</button>
    <button id="googleBtn" class="w-full py-2 mb-2 rounded bg-red-600">Continue with Google</button>
  </div>

  <!-- Home -->
  <div id="homeScreen" class="screen locked">
    <div id="homeLock" class="center-lock"><span class="lock-btn">üîí</span></div>
    <div id="homeContent" style="display:none;">
      <h2 class="text-xl font-bold mb-4">üìà Home</h2>
      <div id="balances"></div>
      <div class="mt-4">
        <h3 class="font-semibold">Quick Trade</h3>
        <input id="tradeSymbol" placeholder="Symbol (e.g. BTCUSDT)" class="w-full p-2 mb-2 rounded bg-gray-900" />
        <input id="tradeAmount" placeholder="Amount" class="w-full p-2 mb-2 rounded bg-gray-900" />
        <button onclick="placeOrder('buy')" class="w-full py-2 mb-2 rounded bg-green-600">Buy</button>
        <button onclick="placeOrder('sell')" class="w-full py-2 rounded bg-red-600">Sell</button>
      </div>
    </div>
  </div>

  <!-- Search -->
  <div id="searchScreen" class="screen locked">
    <div id="searchLock" class="center-lock"><span class="lock-btn">üîí</span></div>
    <div id="searchContent" style="display:none;">
      <h2 class="text-xl font-bold">üîç Search</h2>
      <input id="searchBar" placeholder="Search symbol..." class="w-full p-2 mb-2 rounded bg-gray-900" />
      <div id="searchResults"></div>
    </div>
  </div>

  <!-- Admin -->
  <div id="adminScreen" class="screen locked">
    <div id="adminLock" class="center-lock"><span class="lock-btn">üîí</span></div>
    <div id="adminContent" style="display:none;">
      <h2 class="text-xl font-bold">‚öôÔ∏è Admin Panel</h2>
      <p>Manage keys and users here (admin only).</p>
    </div>
  </div>

  <!-- Account -->
  <div id="accountScreen" class="screen">
    <h2 class="text-xl font-bold">üë§ Account</h2>
    <p>Connect your broker below:</p>
    <div id="brokersList">
      <div id="zerodhaBalance">Zerodha: <span class="bal">Connect Broker</span> <button onclick="connectBroker('zerodha')">Connect</button></div>
      <div id="angelBalance">AngelOne: <span class="bal">Connect Broker</span> <button onclick="connectBroker('angelone')">Connect</button></div>
      <div id="binanceBalance">Binance: <span class="bal">Connect Broker</span> <button onclick="connectBroker('binance')">Connect</button></div>
      <div id="exnessBalance">Exness: <span class="bal">Connect Broker</span> <button onclick="connectBroker('exness')">Connect</button></div>
    </div>
    <hr class="my-3 border-gray-700" />
    <h3 class="font-semibold mb-2">Funds</h3>
    <button onclick="deposit()" class="w-full py-2 mb-2 rounded bg-green-600">Deposit</button>
    <button onclick="withdraw()" class="w-full py-2 rounded bg-red-600">Withdraw</button>
  </div>

  <!-- Bottom nav -->
  <div class="nav">
    <button onclick="showScreen('homeScreen')">Home</button>
    <button onclick="showScreen('searchScreen')">Search</button>
    <button onclick="showScreen('adminScreen')">Admin</button>
    <button onclick="showScreen('accountScreen')">Account</button>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC-Vt0JpfAMj9uTdZHXXyot2FvB4lQ_vvE",
      authDomain: "protraderhack-d67f0.firebaseapp.com",
      projectId: "protraderhack-d67f0",
      storageBucket: "protraderhack-d67f0.appspot.com",
      messagingSenderId: "1062485216321",
      appId: "1:1062485216321:web:f34bb52a8acc0a75b24ac0"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    const BACKEND = "https://protrader-backend-sbus.onrender.com";

    function showScreen(id){
      document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      if(id==="homeScreen") refreshBalances();
      if(id==="accountScreen") refreshBalances();
    }

    // Unlock logic
    document.querySelector("#homeLock .lock-btn").onclick = ()=>unlock('home');
    document.querySelector("#searchLock .lock-btn").onclick = ()=>unlock('search');
    document.querySelector("#adminLock .lock-btn").onclick = ()=>unlock('admin');

    function unlock(type){
      const key = prompt("Enter unlock key:");
      const userKeys = { "pth7":7, "key15":15, "ishaan30":30, "splkey50":50, "ishaan":"perm" };
      const adminKeys = ["vamya","pthowner16"];

      if(type==="home" || type==="search"){
        if(key in userKeys){
          ["home","search"].forEach(sec=>{
            document.getElementById(sec+"Screen").classList.remove("locked");
            document.getElementById(sec+"Lock").style.display="none";
            document.getElementById(sec+"Content").style.display="block";
          });
          alert("‚úÖ Home & Search unlocked!");
        } else alert("‚ùå Invalid key");
      }
      if(type==="admin"){
        if(adminKeys.includes(key)){
          document.getElementById("adminScreen").classList.remove("locked");
          document.getElementById("adminLock").style.display="none";
          document.getElementById("adminContent").style.display="block";
          alert("‚úÖ Admin unlocked!");
        } else alert("‚ùå Invalid admin key");
      }
    }

    // Auth
    document.getElementById('signupBtn').onclick = async ()=>{
      const user = document.getElementById('username').value;
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      if(!/^[a-z0-9]{1,12}$/.test(user)){ alert("Invalid username!"); return; }
      await auth.createUserWithEmailAndPassword(email,pass);
      localStorage.setItem("uid", auth.currentUser.uid);
      localStorage.setItem("username", user);
      showScreen('homeScreen');
    };

    document.getElementById('loginBtn').onclick = async ()=>{
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      await auth.signInWithEmailAndPassword(email,pass);
      localStorage.setItem("uid", auth.currentUser.uid);
      showScreen('homeScreen');
    };

    document.getElementById('googleBtn').onclick = async ()=>{
      const provider = new firebase.auth.GoogleAuthProvider();
      await auth.signInWithPopup(provider);
      localStorage.setItem("uid", auth.currentUser.uid);
      showScreen('homeScreen');
    };

    // Broker interactions
    async function connectBroker(name){
      const uid = localStorage.getItem("uid");
      if(!uid) return alert("Login first");
      await fetch(`${BACKEND}/broker/connect`,{
        method:"POST", headers:{'Content-Type':'application/json'},
        body:JSON.stringify({uid,broker:name,api_key:"demo",secret:"demo"})
      });
      refreshBalances();
    }

    async function refreshBalances(){
      const uid = localStorage.getItem("uid");
      const balancesDiv = document.getElementById("balances");
      balancesDiv.innerHTML = "";
      for(const b of ["zerodha","angelone","binance","exness"]){
        const res = await fetch(`${BACKEND}/balance`,{
          method:"POST", headers:{'Content-Type':'application/json'},
          body:JSON.stringify({uid,broker:b})
        });
        const d = await res.json();
        balancesDiv.innerHTML += `<div class="balance-box">${b.toUpperCase()}: ${d.balance || "Connect Broker"}</div>`;
        document.querySelector(`#${b}Balance .bal`).innerText = d.balance || "Connect Broker";
      }
    }

    async function deposit(){
      const uid = localStorage.getItem("uid");
      const broker = prompt("Which broker? (zerodha/angelone/binance/exness)");
      const amount = prompt("Enter amount");
      const res = await fetch(`${BACKEND}/deposit`,{
        method:"POST", headers:{'Content-Type':'application/json'},
        body:JSON.stringify({uid,broker,amount})
      });
      const d = await res.json();
      if(d.redirect) window.location.href = d.redirect;
      else alert("Deposit "+d.status);
      refreshBalances();
    }

    async function withdraw(){
      const uid = localStorage.getItem("uid");
      const broker = prompt("Which broker? (zerodha/angelone/binance/exness)");
      const amount = prompt("Enter amount");
      const res = await fetch(`${BACKEND}/withdraw`,{
        method:"POST", headers:{'Content-Type':'application/json'},
        body:JSON.stringify({uid,broker,amount})
      });
      const d = await res.json();
      if(d.redirect) window.location.href = d.redirect;
      else alert("Withdraw "+d.status);
      refreshBalances();
    }

    async function placeOrder(side){
      const uid = localStorage.getItem("uid");
      const broker = prompt("Which broker to trade on? (zerodha/angelone/binance/exness)");
      const symbol = document.getElementById("tradeSymbol").value;
      const amount = document.getElementById("tradeAmount").value;
      const res = await fetch(`${BACKEND}/trade`,{
        method:"POST", headers:{'Content-Type':'application/json'},
        body:JSON.stringify({uid,broker,symbol,amount,side})
      });
      const d = await res.json();
      alert(`${side.toUpperCase()} order ${d.status}`);
      refreshBalances();
    }

    // Auto refresh balances every 60s
    setInterval(refreshBalances, 60000);
  </script>
</body>
        </html>
