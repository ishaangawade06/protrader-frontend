<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ProTraderHack</title>

  <!-- Chart lib -->
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    body{font-family:Inter,Arial;background:#071127;color:#e6eef8;margin:0;padding:12px;}
    .card{background:#0f1724;padding:12px;border-radius:10px;margin-bottom:12px;}
    input,select,button{padding:10px;border-radius:8px;border:0;background:#0b1320;color:#e6eef8;width:100%;margin:6px 0;}
    nav{position:fixed;left:0;right:0;bottom:0;background:#0b1220;display:flex;gap:6px;padding:8px;border-top:1px solid rgba(255,255,255,0.03);}
    nav button{flex:1;background:none;border:0;color:#9aa6b2;padding:8px;font-size:15px;}
    nav button.active{color:#60a5fa;}
    #chart{height:320px;}
    .small{font-size:13px;color:#9aa6b2;}
    ul.list{list-style:none;padding:0;margin:0;max-height:260px;overflow:auto;}
    li.item{padding:8px;border-bottom:1px solid rgba(255,255,255,0.02);display:flex;justify-content:space-between;}
    #introVideo{width:100%;border-radius:10px;}
  </style>
</head>
<body>
  <div id="app">

    <!-- Intro video card (plays once) -->
    <div id="intro" class="card" style="display:none;">
      <video id="introVideo" controls>
        <source src="VID-20250904-WA0075.mp4" type="video/mp4">
        Your browser does not support the video tag.
      </video>
      <div style="display:flex;gap:8px;margin-top:8px;">
        <button id="skipIntro" class="">Skip</button>
      </div>
    </div>

    <!-- Auth -->
    <div id="auth" class="card">
      <h2>üîí Login / Sign up</h2>
      <input id="email" placeholder="Email" type="email">
      <input id="password" placeholder="Password" type="password">
      <input id="username" placeholder="Username (a-z0-9, max12)">
      <div style="display:flex;gap:8px;">
        <button onclick="signup()">Sign Up</button>
        <button onclick="login()">Login</button>
      </div>
      <p class="small">Google login not included here ‚Äî add later if you want.</p>
    </div>

    <!-- Key gate -->
    <div id="keyGate" class="card" style="display:none;">
      <h3>üîë Enter your key to unlock</h3>
      <input id="userKey" placeholder="Enter key (e.g. pth7)">
      <button onclick="validateKey()">Unlock</button>
      <p class="small">Keys: pth7 (7d), key15 (15d), ishaan30 (30d), splkey50 (50d), ishaan (permanent)</p>
    </div>

    <!-- Home (charts + signals) -->
    <div id="home" style="display:none;">
      <div class="card">
        <h3>üè† Home</h3>
        <div style="display:flex;gap:8px;margin-bottom:8px;">
          <input id="chartSymbol" value="BTC/USDT" placeholder="Symbol">
          <select id="chartTf"><option>1m</option><option>5m</option><option>15m</option><option>1h</option><option>1d</option></select>
          <button onclick="loadChart()">Load</button>
        </div>
        <div id="chart" class="card"></div>
      </div>

      <div class="card">
        <h4>Signals</h4>
        <ul id="signalsList" class="list"></ul>
      </div>
    </div>

    <!-- Search -->
    <div id="search" class="card" style="display:none;">
      <h3>üîé Search & Watchlist</h3>
      <input id="searchInput" placeholder="Symbol e.g. BTC/USDT or INFY-NSE">
      <button onclick="addToWatchlist()">Add to watchlist</button>
      <h4 class="small">Watchlist</h4>
      <ul id="watchlist" class="list"></ul>
    </div>

    <!-- Notifications -->
    <div id="notifications" class="card" style="display:none;">
      <h3>üîî Notifications</h3>
      <ul id="notifList" class="list"></ul>
    </div>

    <!-- Account -->
    <div id="account" class="card" style="display:none;">
      <h3>üë§ Account</h3>
      <p class="small">Username & broker connection</p>
      <input id="brokerSelect" list="brokers" placeholder="Select broker (binance/exness/zerodha/angelone)">
      <datalist id="brokers"><option>binance</option><option>exness</option><option>zerodha</option><option>angelone</option></datalist>
      <input id="brokerApiKey" placeholder="Broker API Key">
      <input id="brokerSecret" placeholder="Broker Secret">
      <button onclick="connectBroker()">Connect Broker</button>

      <hr style="margin:8px 0;border-color:rgba(255,255,255,0.03)">

      <h4>Deposit / Withdraw</h4>
      <input id="amount" placeholder="Amount">
      <div style="display:flex;gap:8px;">
        <button onclick="deposit()">Deposit</button>
        <button onclick="withdraw()">Withdraw</button>
      </div>

      <h4 style="margin-top:8px;">Transactions</h4>
      <ul id="txList" class="list"></ul>
    </div>

    <!-- Admin (only visible when admin role) -->
    <div id="admin" class="card" style="display:none;">
      <h3>‚öôÔ∏è Admin</h3>
      <input id="adminMessage" placeholder="Message">
      <input id="adminSymbol" placeholder="Symbol">
      <select id="adminSignal"><option>INFO</option><option>BUY</option><option>SELL</option></select>
      <input id="adminPrice" placeholder="Price">
      <button onclick="broadcast()">Broadcast</button>
    </div>

  </div>

  <nav>
    <button id="navHome" class="active" onclick="nav('home')">Home</button>
    <button id="navSearch" onclick="nav('search')">Search</button>
    <button id="navNotif" onclick="nav('notifications')">Notifications</button>
    <button id="navAccount" onclick="nav('account')">Account</button>
    <button id="navAdmin" onclick="nav('admin')">Admin</button>
  </nav>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    const BACKEND = (location.hostname.includes('localhost') ? 'http://localhost:5000' : 'https://protrader-backend-sbus.onrender.com');

    const firebaseConfig = {
      apiKey: "AIzaSyC-Vt0JpfAMj9uTdZHXXyot2FvB4lQ_vvE",
      authDomain: "protraderhack-d67f0.firebaseapp.com",
      projectId: "protraderhack-d67f0",
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- session for intro video (play once per session) ---
    if (!sessionStorage.getItem('intro_played')) {
      document.getElementById('intro').style.display = 'block';
      document.getElementById('auth').style.display = 'none';
      document.getElementById('skipIntro').onclick = () => {
        document.getElementById('intro').style.display = 'none';
        document.getElementById('auth').style.display = 'block';
        sessionStorage.setItem('intro_played', '1');
      };
      // if video ends
      document.getElementById('introVideo').onended = () => {
        document.getElementById('intro').style.display = 'none';
        document.getElementById('auth').style.display = 'block';
        sessionStorage.setItem('intro_played', '1');
      };
    } else {
      document.getElementById('intro').style.display = 'none';
    }

    // UI navigation
    function show(section) {
      ['home','search','notifications','account','admin'].forEach(s => {
        document.getElementById(s).style.display = (s === section) ? 'block' : 'none';
      });
      document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
      const map = {home:'navHome', search:'navSearch', notifications:'navNotif', account:'navAccount', admin:'navAdmin'};
      document.getElementById(map[section]).classList.add('active');
    }
    function nav(section){ show(section); }

    // --- auth & username rules ---
    async function signup(){
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const username = document.getElementById('username').value;
      if(!/^[a-z0-9]{1,12}$/.test(username)){
        return alert('Username must be lowercase letters/numbers and max 12 characters');
      }
      try {
        await auth.createUserWithEmailAndPassword(email, password);
        const u = auth.currentUser;
        if(u){
          await db.collection('users').doc(u.uid).set({ username, created_at: new Date().toISOString() });
        }
        alert('Account created');
      } catch(e){ alert(e.message); }
    }
    async function login(){
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      try {
        await auth.signInWithEmailAndPassword(email,password);
      } catch(e){ alert(e.message); }
    }
    function signout(){ auth.signOut(); }

    auth.onAuthStateChanged(user=>{
      if(user){
        document.getElementById('auth').style.display = 'none';
        document.getElementById('keyGate').style.display = 'block';
      } else {
        document.getElementById('auth').style.display = 'block';
        document.getElementById('keyGate').style.display = 'none';
        show('home');
      }
    });

    // --- validate key ---
    async function validateKey(){
      const key = document.getElementById('userKey').value.trim();
      if(!key) return alert('Enter key');
      const res = await fetch(BACKEND + '/validate_key', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({key})});
      const d = await res.json();
      if(d.valid){
        alert('Unlocked');
        sessionStorage.setItem('active_key', key);
        document.getElementById('keyGate').style.display = 'none';
        show('home');
        subscribeRealtime();
        loadSignals();
        loadTransactions();
        listenNotificationsForKey(key);
        // if user is owner check admin privileges
        if(d.role === 'owner') document.getElementById('admin').style.display = 'block';
      } else {
        alert('Invalid key: ' + (d.reason || 'unknown'));
      }
    }

    // --- charts ---
    let chart, series;
    async function loadChart(){
      const symbol = document.getElementById('chartSymbol').value || 'BTC/USDT';
      const tf = document.getElementById('chartTf').value || '1m';
      const url = `${BACKEND}/ohlc?symbol=${encodeURIComponent(symbol)}&tf=${tf}&limit=200`;
      const res = await fetch(url);
      const data = await res.json();
      if(data.error) return alert('Chart error: ' + data.error);
      const formatted = (data.data || []).map(d=>({ time: Math.floor(d[0]/1000), open:d[1], high:d[2], low:d[3], close:d[4] }));
      const container = document.getElementById('chart');
      container.innerHTML = '';
      chart = LightweightCharts.createChart(container, { layout: { background: '#0f1724', textColor:'#e6eef8' }});
      series = chart.addCandlestickSeries();
      series.setData(formatted);
    }

    // --- signals ---
    async function loadSignals(){
      const res = await fetch(BACKEND + '/signals?limit=50');
      const arr = await res.json();
      const el = document.getElementById('signalsList'); el.innerHTML = '';
      arr.forEach(s=>{
        const li = document.createElement('li'); li.className='item';
        li.innerHTML = `<div><strong>${s.symbol}</strong><div class="small">${s.signal} ‚Ä¢ ${s.timestamp}</div></div><div>${s.meta?.last_price || ''}</div>`;
        el.appendChild(li);
      });
    }

    // realtime subscriptions (basic)
    function subscribeRealtime(){
      db.collection('signals').orderBy('timestamp','desc').limit(20).onSnapshot(loadSignals);
    }

    // --- watchlist & search ---
    let watchlist = [];
    function addToWatchlist(){
      const s = document.getElementById('searchInput').value.trim();
      if(!s) return alert('Enter symbol');
      watchlist.unshift(s); renderWatchlist();
    }
    function renderWatchlist(){
      const el = document.getElementById('watchlist'); el.innerHTML = '';
      watchlist.forEach(sym=>{
        const li = document.createElement('li'); li.className='item';
        li.innerHTML = `<div>${sym}</div><div><button onclick="document.getElementById('chartSymbol').value='${sym}'; loadChart()">View</button></div>`;
        el.appendChild(li);
      });
    }

    // --- notifications for active key ---
    function listenNotificationsForKey(key){
      db.collection('notifications').where('key','==',key).orderBy('timestamp','desc').limit(50).onSnapshot(snap=>{
        const el = document.getElementById('notifList'); el.innerHTML = '';
        snap.forEach(d=>{
          const n = d.data();
          const li = document.createElement('li'); li.className='item';
          li.innerHTML = `<div><strong>${n.signal?.meta?.symbol || '-'}</strong><div class="small">${n.message || ''} ‚Ä¢ ${n.timestamp}</div></div><div>${n.signal?.signal || ''}</div>`;
          el.appendChild(li);
          // mobile popup
          if(n.message) setTimeout(()=>alert('üîî ' + (n.message || 'signal')), 200);
        });
      });
    }

    // --- broker connect ---
    async function connectBroker(){
      const user = auth.currentUser; if(!user) return alert('Login required');
      const broker = document.getElementById('brokerSelect').value.trim().toLowerCase();
      const api = document.getElementById('brokerApiKey').value.trim();
      const secret = document.getElementById('brokerSecret').value.trim();
      if(!broker || !api || !secret) return alert('Fill broker, api and secret');
      await db.collection('users').doc(user.uid).set({ brokers: { [broker]: { api, secret } } }, { merge: true });
      alert('Broker saved: ' + broker);
    }

    // --- deposit / withdraw ---
    async function deposit(){
      const broker = (document.getElementById('brokerSelect').value || '').trim().toLowerCase();
      const amount = parseFloat(document.getElementById('amount').value || '0');
      if(!broker || !amount) return alert('Select broker and amount');
      const user = auth.currentUser;
      const payload = { user: user ? (user.email || user.uid) : 'guest', broker, amount };
      const res = await fetch(BACKEND + '/deposit', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const d = await res.json();
      if(d.status === 'redirect' && d.redirect_url) window.open(d.redirect_url, '_blank');
      else alert('Deposit: ' + (d.status || JSON.stringify(d)));
      loadTransactions();
    }
    async function withdraw(){
      const broker = (document.getElementById('brokerSelect').value || '').trim().toLowerCase();
      const amount = parseFloat(document.getElementById('amount').value || '0');
      if(!broker || !amount) return alert('Select broker and amount');
      const user = auth.currentUser;
      const payload = { user: user ? (user.email || user.uid) : 'guest', broker, amount };
      const res = await fetch(BACKEND + '/withdraw', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const d = await res.json();
      if(d.status === 'redirect' && d.redirect_url) window.open(d.redirect_url, '_blank');
      else alert('Withdraw: ' + (d.status || JSON.stringify(d)));
      loadTransactions();
    }

    // --- transactions list ---
    async function loadTransactions(){
      const el = document.getElementById('txList'); el.innerHTML = 'Loading...';
      const snap = await db.collection('transactions').orderBy('created_at','desc').limit(20).get();
      el.innerHTML = '';
      snap.forEach(d=>{
        const t = d.data();
        const li = document.createElement('li'); li.className='item';
        li.innerHTML = `<div>${t.type.toUpperCase()} ${t.amount} ‚Äî ${t.broker}</div><div class="small">${t.status}</div>`;
        el.appendChild(li);
      });
    }

    // --- admin broadcast: fetch secret from Firestore at runtime (admin must be in admins collection) ---
    let ADMIN_SECRET = null;
    async function loadAdminSecretIfAdmin(){
      const u = auth.currentUser;
      if(!u) return;
      // check admins collection first
      const admDoc = await db.collection('admins').doc(u.uid).get();
      if(!admDoc.exists) return; // not an admin
      const cfg = await db.collection('admin').doc('config').get();
      if(cfg.exists) ADMIN_SECRET = cfg.data().secret;
      if(ADMIN_SECRET) document.getElementById('admin').style.display = 'block';
    }

    async function broadcast(){
      if(!ADMIN_SECRET) return alert('Admin secret not loaded or you are not admin');
      const body = { message: document.getElementById('adminMessage').value, symbol: document.getElementById('adminSymbol').value, signal: document.getElementById('adminSignal').value, price: document.getElementById('adminPrice').value };
      const res = await fetch(BACKEND + '/send_notification', { method:'POST', headers: { 'Content-Type':'application/json', 'X-Admin-Secret': ADMIN_SECRET }, body: JSON.stringify(body) });
      const data = await res.json();
      if(res.ok) alert('Broadcast sent to ' + (data.sent_to || data.sent));
      else alert('Broadcast failed: ' + (data.error || JSON.stringify(data)));
    }

    // when user logs in, try to load admin secret
    auth.onAuthStateChanged(async u=>{
      if(u){
        await loadAdminSecretIfAdmin();
      } else {
        ADMIN_SECRET = null;
        document.getElementById('admin').style.display = 'none';
      }
    });

    // subscribe realtime on signals
    function subscribeRealtimeAfterUnlock(){
      db.collection('signals').orderBy('timestamp','desc').limit(20).onSnapshot(loadSignals);
    }

    // small init: hide admin and other sections
    ['home','search','notifications','account','admin'].forEach(s => document.getElementById(s).style.display = 'none');
  </script>
</body>
        </html>
