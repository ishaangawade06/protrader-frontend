<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ProTraderHack</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#0b1220; color:#e6eef8; }
    .container { padding:20px; }
    input, select, button { display:block; width:100%; margin:8px 0; padding:10px; border-radius:6px; border:none; }
    button { cursor:pointer; background:#007bff; color:white; font-weight:bold; }
    nav { position:fixed; bottom:0; left:0; right:0; display:flex; background:#0f1724; }
    nav button { flex:1; border-radius:0; padding:15px; }
    .hidden { display:none; }
    h2,h3 { color:#4ade80; }
  </style>
</head>
<body>
  <!-- Auth Screen -->
  <div id="auth-screen" class="container">
    <h2>üîí ProTraderHack Login</h2>
    <input id="username" type="text" placeholder="Username (a-z0-9, max12)">
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button onclick="signup()">Sign Up</button>
    <button onclick="login()">Login</button>
    <button onclick="googleLogin()">Login with Google</button>
  </div>

  <!-- Locked Screen -->
  <div id="locked-screen" class="container hidden" style="text-align:center;">
    <h2>üîí Enter Unlock Key</h2>
    <input id="unlockKey" placeholder="Enter Key">
    <button onclick="unlockApp()">Unlock</button>
  </div>

  <!-- Home Screen -->
  <div id="home-screen" class="container hidden">
    <h2>üìä Trading Dashboard</h2>
    <div id="signal-feed"></div>

    <h3 style="margin-top:20px;">‚ö° Quick Trade (Binance/Exness)</h3>
    <input id="tradeSymbol" placeholder="Symbol (e.g. BTC/USDT)">
    <input id="tradeAmount" placeholder="Amount (e.g. 0.001)">
    <button onclick="placeOrder('buy')">Buy</button>
    <button onclick="placeOrder('sell')">Sell</button>
    <div id="tradeResult"></div>

    <div id="zerodhaTrade" style="margin-top:20px; display:none;">
      <h3>üìà Zerodha Trade</h3>
      <input id="zSymbol" placeholder="Symbol (e.g. INFY)">
      <input id="zQty" placeholder="Quantity" type="number">
      <select id="zSide">
        <option value="buy">Buy</option>
        <option value="sell">Sell</option>
      </select>
      <button onclick="placeZerodhaOrder()">Place Order</button>
      <p id="zTradeResult"></p>
    </div>
  </div>

  <!-- Search Screen -->
  <div id="search-screen" class="container hidden">
    <h2>üîç Search Assets</h2>
    <p>(Coming soon: search crypto/stocks/forex & add to watchlist)</p>
  </div>

  <!-- Admin Screen -->
  <div id="admin-screen" class="container hidden">
    <h2>‚öôÔ∏è Admin Panel</h2>
    <p>Only for keys: vamya, pthowner16</p>
  </div>

  <!-- Account Screen -->
  <div id="account-screen" class="container hidden">
    <h2>üë§ My Account</h2>
    <p id="account-info"></p>

    <h3>üîë Connect Broker</h3>
    <select id="brokerName">
      <option value="binance">Binance</option>
      <option value="exness">Exness</option>
      <option value="zerodha">Zerodha</option>
      <option value="angelone">AngelOne</option>
      <option value="quotex">Quotex</option>
    </select>

    <input id="apiKey" placeholder="API Key">
    <input id="secretKey" placeholder="Secret Key">
    <input id="extraToken" placeholder="Token (for Zerodha/AngelOne)" style="display:none;">

    <button onclick="saveBrokerKeys()">Save Keys</button>
    <button onclick="fetchBalance()">Check Balance</button>

    <div id="zerodhaSection" style="display:none; margin-top:15px;">
      <button onclick="linkZerodha()">Link Zerodha</button>
      <button onclick="fetchZerodhaBalance()">Check Zerodha Balance</button>
    </div>

    <p id="balanceInfo" style="margin-top:15px; font-weight:bold;"></p>
    <button style="margin-top:20px;" onclick="logout()">Logout</button>
  </div>

  <!-- Navigation -->
  <nav>
    <button onclick="showTab('home')">Home</button>
    <button onclick="showTab('search')">Search</button>
    <button onclick="showTab('admin')">Admin</button>
    <button onclick="showTab('account')">Account</button>
  </nav>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyC-Vt0JpfAMj9uTdZHXXyot2FvB4lQ_vvE",
      authDomain: "protraderhack-d67f0.firebaseapp.com",
      projectId: "protraderhack-d67f0",
      storageBucket: "protraderhack-d67f0.firebasestorage.app",
      messagingSenderId: "1062485216321",
      appId: "1:1062485216321:web:f34bb52a8acc0a75b24ac0"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Username validation
    function validateUsername(name){ return /^[a-z0-9]{1,12}$/.test(name); }

    // Signup
    async function signup(){
      const uname=document.getElementById("username").value.trim();
      const email=document.getElementById("email").value.trim();
      const pass=document.getElementById("password").value;
      if(!validateUsername(uname)){ alert("‚ùå Invalid username"); return; }
      const q=await db.collection("users").where("username","==",uname).get();
      if(!q.empty){ alert("‚ùå Username taken"); return; }
      try{
        const userCred=await auth.createUserWithEmailAndPassword(email,pass);
        await db.collection("users").doc(userCred.user.uid).set({ username:uname,email,createdAt:new Date().toISOString() });
      }catch(err){ alert("‚ùå "+err.message); }
    }

    // Login
    async function login(){
      const email=document.getElementById("email").value.trim();
      const pass=document.getElementById("password").value;
      try{ await auth.signInWithEmailAndPassword(email,pass); }
      catch(err){ alert("‚ùå "+err.message); }
    }

    // Google login
    async function googleLogin(){
      const provider=new firebase.auth.GoogleAuthProvider();
      try{
        const res=await auth.signInWithPopup(provider);
        const uid=res.user.uid; const email=res.user.email;
        const doc=await db.collection("users").doc(uid).get();
        if(!doc.exists){
          let uname=prompt("Choose username (a-z0-9, max12):").trim();
          if(!validateUsername(uname)){ alert("‚ùå Invalid username"); await auth.signOut(); return; }
          const q=await db.collection("users").where("username","==",uname).get();
          if(!q.empty){ alert("‚ùå Username taken"); await auth.signOut(); return; }
          await db.collection("users").doc(uid).set({ username:uname,email,createdAt:new Date().toISOString() });
        }
      }catch(err){ alert("‚ùå "+err.message); }
    }

    // Unlock app with key
    function unlockApp(){
      const key=document.getElementById("unlockKey").value.trim();
      const valid=["pth7","key15","ishaan30","splkey50","ishaan"];
      if(valid.includes(key)){ showTab("home"); showTab("search"); }
      else alert("‚ùå Invalid key");
    }

    // Logout
    function logout(){ auth.signOut(); location.reload(); }

    // Auth state
    auth.onAuthStateChanged(user=>{
      if(user){ document.getElementById("auth-screen").style.display="none"; document.getElementById("locked-screen").style.display="block"; }
      else { document.getElementById("auth-screen").style.display="block"; }
    });

    // Tab navigation
    function showTab(tab){
      document.getElementById("home-screen").classList.add("hidden");
      document.getElementById("search-screen").classList.add("hidden");
      document.getElementById("admin-screen").classList.add("hidden");
      document.getElementById("account-screen").classList.add("hidden");
      if(tab==="home") document.getElementById("home-screen").classList.remove("hidden");
      if(tab==="search") document.getElementById("search-screen").classList.remove("hidden");
      if(tab==="admin") document.getElementById("admin-screen").classList.remove("hidden");
      if(tab==="account") document.getElementById("account-screen").classList.remove("hidden");
    }

    // Broker dropdown
    document.getElementById("brokerName").addEventListener("change",()=>{
      const val=document.getElementById("brokerName").value;
      document.getElementById("extraToken").style.display=(val==="zerodha"||val==="angelone")?"block":"none";
      document.getElementById("zerodhaSection").style.display=(val==="zerodha")?"block":"none";
      document.getElementById("zerodhaTrade").style.display=(val==="zerodha")?"block":"none";
    });

    // Save broker keys
    async function saveBrokerKeys(){
      const broker=document.getElementById("brokerName").value;
      const apiKey=document.getElementById("apiKey").value.trim();
      const secretKey=document.getElementById("secretKey").value.trim();
      const token=document.getElementById("extraToken").value.trim();
      const user=auth.currentUser; if(!user){ alert("Not logged in"); return; }
      await db.collection("users").doc(user.uid).update({ broker:{ name:broker, apiKey, secretKey, token } });
      alert("‚úÖ Broker saved: "+broker);
    }

    // Fetch balance
    async function fetchBalance(){
      const user=auth.currentUser; if(!user){ alert("Not logged in"); return; }
      const doc=await db.collection("users").doc(user.uid).get();
      if(!doc.exists||!doc.data().broker){ alert("‚ùå No broker"); return; }
      const broker=doc.data().broker;
      const res=await fetch("https://protrader-backend-sbus.onrender.com/balance",{ method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify(broker) });
      const data=await res.json();
      if(data.error) document.getElementById("balanceInfo").innerText="‚ùå "+data.error;
      else document.getElementById("balanceInfo").innerText="‚úÖ "+JSON.stringify(data);
    }

    // Link Zerodha
    async function linkZerodha(){
      const user=auth.currentUser; if(!user){ alert("Not logged in"); return; }
      const res=await fetch("https://protrader-backend-sbus.onrender.com/zerodha/login?uid="+user.uid);
      const data=await res.json();
      if(data.login_url){ window.open(data.login_url,"_blank"); alert("Complete Zerodha login in new tab"); }
      else alert("‚ùå "+data.error);
    }

    // Fetch Zerodha balance
    async function fetchZerodhaBalance(){
      const user=auth.currentUser; if(!user){ alert("Not logged in"); return; }
      const res=await fetch("https://protrader-backend-sbus.onrender.com/zerodha/balance",{ method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify({ uid:user.uid }) });
      const data=await res.json();
      if(data.error) alert("‚ùå "+data.error);
      else document.getElementById("balanceInfo").innerText="Funds: "+JSON.stringify(data.funds);
    }

    // Place order (Binance/Exness)
    async function placeOrder(side){
      const symbol=document.getElementById("tradeSymbol").value.trim();
      const amount=parseFloat(document.getElementById("tradeAmount").value);
      if(!symbol||!amount){ alert("Enter symbol & amount"); return; }
      const user=auth.currentUser; const doc=await db.collection("users").doc(user.uid).get();
      if(!doc.exists||!doc.data().broker){ alert("‚ùå No broker"); return; }
      const broker=doc.data().broker;
      const res=await fetch("https://protrader-backend-sbus.onrender.com/trade",{ method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify({ ...broker, symbol, side, amount }) });
      const data=await res.json();
      document.getElementById("tradeResult").innerText=data.error?"‚ùå "+data.error:"‚úÖ Order Placed: "+JSON.stringify(data);
    }

    // Place Zerodha order
    async function placeZerodhaOrder(){
      const user=auth.currentUser; if(!user){ alert("Not logged in"); return; }
      const symbol=document.getElementById("zSymbol").value.trim();
      const qty=parseInt(document.getElementById("zQty").value);
      const side=document.getElementById("zSide").value;
      if(!symbol||!qty){ alert("Enter symbol & qty"); return; }
      const confirmMsg=`‚ö†Ô∏è Confirm ${side.toUpperCase()} order:\nSymbol: ${symbol}\nQty: ${qty}\nExchange: NSE\nType: MARKET (LIVE)`;
      if(!confirm(confirmMsg)) return;
      const res=await fetch("https://protrader-backend-sbus.onrender.com/zerodha/trade",{ method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify({ uid:user.uid, symbol, quantity:qty, side }) });
      const data=await res.json();
      document.getElementById("zTradeResult").innerText=data.error?"‚ùå "+data.error:"‚úÖ Order ID: "+data.order_id;
    }
  </script>
</body>
</html>
