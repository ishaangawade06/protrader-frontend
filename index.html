<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PTH App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { background: #0b1220; color: #e6eef8; font-family: Inter, Arial; }
    .card { background: #0f1724; padding: 16px; border-radius: 10px; }
    .hidden { display: none; }
  </style>
</head>
<body class="p-4">

  <!-- Auth -->
  <div id="auth-screen" class="card max-w-md mx-auto">
    <h2 class="text-lg font-semibold mb-3">Login / Sign Up</h2>
    <input id="email" type="email" placeholder="Email" class="w-full p-2 mb-2 rounded bg-gray-900">
    <input id="password" type="password" placeholder="Password" class="w-full p-2 mb-2 rounded bg-gray-900">
    <input id="username" type="text" placeholder="Username (letters+numbers, max 12)" class="w-full p-2 mb-2 rounded bg-gray-900">
    <button onclick="signup()" class="w-full py-2 bg-green-600 rounded mb-2">Sign Up</button>
    <button onclick="login()" class="w-full py-2 bg-blue-600 rounded">Login</button>
  </div>

  <!-- Home -->
  <div id="home-screen" class="hidden">
    <h2 class="text-xl font-bold text-green-400 mb-4">Welcome to PTH</h2>

    <!-- Deposit/Withdraw -->
    <div class="card mb-4">
      <h3 class="font-semibold mb-2">Deposit / Withdraw</h3>
      <select id="brokerSelect" class="w-full mb-2 p-2 rounded bg-gray-900">
        <option value="binance">Binance</option>
        <option value="exness">Exness</option>
        <option value="zerodha">Zerodha</option>
        <option value="angelone">AngelOne</option>
      </select>
      <input id="amount" type="number" placeholder="Amount" class="w-full p-2 mb-2 rounded bg-gray-900">
      <div class="flex gap-2">
        <button onclick="deposit()" class="flex-1 py-2 bg-green-600 rounded">Deposit</button>
        <button onclick="withdraw()" class="flex-1 py-2 bg-red-600 rounded">Withdraw</button>
      </div>
    </div>

    <!-- Transactions -->
    <div class="card">
      <h3 class="font-semibold mb-2">Transactions</h3>
      <ul id="txList" class="text-sm"></ul>
    </div>

    <button onclick="logout()" class="mt-4 py-2 px-4 bg-gray-700 rounded">Logout</button>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC-Vt0JpfAMj9uTdZHXXyot2FvB4lQ_vvE",
      authDomain: "protraderhack-d67f0.firebaseapp.com",
      projectId: "protraderhack-d67f0",
      storageBucket: "protraderhack-d67f0.firebasestorage.app",
      messagingSenderId: "1062485216321",
      appId: "1:1062485216321:web:f34bb52a8acc0a75b24ac0"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const BACKEND_URL = "https://protrader-backend-sbus.onrender.com";

    // -------- AUTH --------
    async function signup() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const username = document.getElementById("username").value;

      if (!/^[a-z0-9]{1,12}$/.test(username)) {
        alert("❌ Username must be lowercase letters/numbers, max 12.");
        return;
      }

      try {
        await auth.createUserWithEmailAndPassword(email, password);
        const user = auth.currentUser;
        if (user) {
          await db.collection("users").doc(user.uid).set({ username });
        }
        alert("✅ Account created!");
      } catch (err) {
        alert("❌ " + err.message);
      }
    }

    async function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (err) {
        alert("❌ " + err.message);
      }
    }

    function logout() {
      auth.signOut();
    }

    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById("auth-screen").style.display = "none";
        document.getElementById("home-screen").style.display = "block";
        loadTransactions();
      } else {
        document.getElementById("auth-screen").style.display = "block";
        document.getElementById("home-screen").style.display = "none";
      }
    });

    // -------- DEPOSIT / WITHDRAW --------
    async function deposit() {
      const broker = document.getElementById("brokerSelect").value;
      const amount = document.getElementById("amount").value;

      const res = await fetch(`${BACKEND_URL}/deposit`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ broker, amount })
      });
      const data = await res.json();
      if (data.status === "redirect") {
        window.open(data.url, "_blank");
      } else {
        alert("Deposit: " + data.status);
      }
      loadTransactions();
    }

    async function withdraw() {
      const broker = document.getElementById("brokerSelect").value;
      const amount = document.getElementById("amount").value;

      const res = await fetch(`${BACKEND_URL}/withdraw`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ broker, amount })
      });
      const data = await res.json();
      if (data.status === "redirect") {
        window.open(data.url, "_blank");
      } else {
        alert("Withdraw: " + data.status);
      }
      loadTransactions();
    }

    // -------- TRANSACTIONS --------
    async function loadTransactions() {
      const el = document.getElementById("txList");
      el.innerHTML = "";
      const snap = await db.collection("transactions")
        .orderBy("created_at", "desc")
        .limit(10)
        .get();
      snap.forEach(doc => {
        const t = doc.data();
        el.innerHTML += `<li>${t.type} ${t.amount} on ${t.broker} — ${t.status}</li>`;
      });
    }
  </script>
</body>
  </html>
