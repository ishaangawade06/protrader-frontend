<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ProTraderHack</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { background:#0b1220; color:#e6eef8; font-family:Inter,Arial; }
    .nav { position:fixed; bottom:0; left:0; right:0; display:flex; background:#0f1724; padding:10px; justify-content:space-around; }
    .tab { flex:1; text-align:center; cursor:pointer; padding:8px; }
    .hidden { display:none; }
    .locked { filter: blur(4px); position: relative; }
    .locked::after { content:'ğŸ”’'; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:2rem; }
  </style>
</head>
<body class="p-4">

  <!-- Auth -->
  <div id="authScreen">
    <h2 class="text-xl mb-4">Login / Signup</h2>
    <input id="email" placeholder="Email" class="w-full p-2 mb-2 rounded bg-gray-900"><br>
    <input id="password" type="password" placeholder="Password" class="w-full p-2 mb-2 rounded bg-gray-900"><br>
    <input id="username" placeholder="Username (a-z0-9, max 12)" class="w-full p-2 mb-2 rounded bg-gray-900"><br>
    <button onclick="signup()" class="px-4 py-2 bg-green-600 rounded">Sign Up</button>
    <button onclick="login()" class="px-4 py-2 bg-blue-600 rounded">Login</button>
    <button onclick="googleLogin()" class="px-4 py-2 bg-red-600 rounded mt-2">Login with Google</button>
  </div>

  <!-- App -->
  <div id="appScreen" class="hidden">
    <!-- Screens -->
    <div id="home" class="locked"><h2 class="text-xl">Home</h2><div id="balances"></div></div>
    <div id="search" class="locked hidden"><h2 class="text-xl">Search</h2></div>
    <div id="admin" class="locked hidden"><h2 class="text-xl">Admin</h2></div>
    <div id="account" class="hidden">
      <h2 class="text-xl mb-2">Account</h2>
      <div id="brokers"></div>
    </div>

    <!-- Bottom nav -->
    <div class="nav">
      <div class="tab" onclick="showTab('home')">ğŸ  Home</div>
      <div class="tab" onclick="showTab('search')">ğŸ” Search</div>
      <div class="tab" onclick="showTab('admin')">ğŸ› ï¸ Admin</div>
      <div class="tab" onclick="showTab('account')">ğŸ‘¤ Account</div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-messaging-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC-Vt0JpfAMj9uTdZHXXyot2FvB4lQ_vvE",
      authDomain: "protraderhack-d67f0.firebaseapp.com",
      projectId: "protraderhack-d67f0",
      storageBucket: "protraderhack-d67f0.firebasestorage.app",
      messagingSenderId: "1062485216321",
      appId: "1:1062485216321:web:f34bb52a8acc0a75b24ac0"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const messaging = firebase.messaging();

    let currentUser = null;

    // Auth
    function signup(){
      let e=document.getElementById("email").value, p=document.getElementById("password").value, u=document.getElementById("username").value;
      if(!/^[a-z0-9]{1,12}$/.test(u)){ alert("Invalid username"); return; }
      auth.createUserWithEmailAndPassword(e,p).then(res=>{
        db.collection("users").doc(res.user.uid).set({username:u, key_valid:false});
      }).catch(err=>alert(err.message));
    }
    function login(){ auth.signInWithEmailAndPassword(email.value,password.value).catch(err=>alert(err.message)); }
    function googleLogin(){ let g=new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(g); }

    auth.onAuthStateChanged(u=>{
      if(u){ currentUser=u; authScreen.classList.add("hidden"); appScreen.classList.remove("hidden"); initMessaging(); }
      else{ authScreen.classList.remove("hidden"); appScreen.classList.add("hidden"); }
    });

    // Tabs
    function showTab(tab){ ["home","search","admin","account"].forEach(t=>document.getElementById(t).classList.add("hidden")); document.getElementById(tab).classList.remove("hidden"); }

    // Unlock with keys
    function unlock(tab, key){
      const validUserKeys={"pth7":7,"key15":15,"ishaan30":30,"splkey50":50,"ishaan":9999};
      const validAdminKeys=["vamya","pthowner16"];
      if(tab=="home"||tab=="search"){ if(key in validUserKeys){ home.classList.remove("locked"); search.classList.remove("locked"); db.collection("users").doc(currentUser.uid).set({key_valid:true},{merge:true}); } }
      if(tab=="admin"){ if(validAdminKeys.includes(key)){ admin.classList.remove("locked"); } }
    }

    // Brokers UI
    const brokers=["zerodha","angelone","binance","exness"];
    function loadBrokers(){ brokersDiv=document.getElementById("brokers"); brokersDiv.innerHTML=""; brokers.forEach(b=>{ brokersDiv.innerHTML+=`<div>${b.toUpperCase()} â€” <button onclick="connectBroker('${b}')">Connect</button> <button onclick="checkBalance('${b}')">Balance</button> <button onclick="deposit('${b}')">Deposit</button> <button onclick="withdraw('${b}')">Withdraw</button></div>`; }); }
    function connectBroker(b){ fetch("/broker/connect",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({uid:currentUser.uid,broker:b,api_key:"demo",secret:"demo"})}); }
    function checkBalance(b){ fetch("/balance",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({uid:currentUser.uid,broker:b})}).then(r=>r.json()).then(j=>alert(b+" balance: "+j.balance)); }
    function deposit(b){ let amt=prompt("Enter amount"); fetch("/deposit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({uid:currentUser.uid,broker:b,amount:amt})}).then(r=>r.json()).then(j=>{ if(j.redirect) location.href=j.redirect; else alert("Deposit "+j.status); }); }
    function withdraw(b){ let amt=prompt("Enter amount"); fetch("/withdraw",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({uid:currentUser.uid,broker:b,amount:amt})}).then(r=>r.json()).then(j=>{ if(j.redirect) location.href=j.redirect; else alert("Withdraw "+j.status); }); }
    loadBrokers();

    // Messaging
    function initMessaging(){
      messaging.requestPermission().then(()=>messaging.getToken()).then(tok=>{ db.collection("users").doc(currentUser.uid).set({fcm_token:tok},{merge:true}); });
      messaging.onMessage(payload=>{ alert("ğŸ”” "+payload.notification.title+" â€” "+payload.notification.body); });
    }
  </script>
</body>
</html>
